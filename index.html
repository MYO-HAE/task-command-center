<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task Command Center | David Kim</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-card: #1a1a24;
      --accent: #6366f1;
      --accent-glow: rgba(99, 102, 241, 0.3);
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --text-primary: #f8fafc;
      --text-secondary: #94a3b8;
      --border: rgba(255, 255, 255, 0.08);
      --david: #3b82f6;
      --alice: #a855f7;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
    }
    
    .bg-gradient {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(ellipse at 20% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
      position: relative;
      z-index: 1;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .brand-icon {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, var(--accent), #8b5cf6);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    
    .brand-text h1 {
      font-size: 20px;
      font-weight: 600;
    }
    
    .brand-text p {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .sync-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .sync-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 2s infinite;
    }

    .sync-dot.syncing { background: var(--warning); }
    .sync-dot.error { background: var(--danger); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .user-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      background: var(--bg-card);
      padding: 6px;
      border-radius: 12px;
      border: 1px solid var(--border);
      width: fit-content;
    }

    .user-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-btn:hover { color: var(--text-primary); }
    .user-btn.active.david { background: var(--david); color: white; }
    .user-btn.active.alice { background: var(--alice); color: white; }

    .nav-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
      background: var(--bg-card);
      padding: 4px;
      border-radius: 10px;
      border: 1px solid var(--border);
      width: fit-content;
    }

    .nav-tab {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      background: transparent;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .nav-tab:hover { color: var(--text-primary); }
    .nav-tab.active { background: var(--accent); color: white; }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .health-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    @media (max-width: 900px) {
      .health-grid { grid-template-columns: 1fr; }
    }

    .health-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
    }

    .health-card.critical { border-color: var(--danger); }
    .health-card.warning { border-color: var(--warning); }
    .health-card.healthy { border-color: var(--success); }

    .health-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 20px;
      margin-bottom: 8px;
    }

    .health-status.critical { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
    .health-status.warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
    .health-status.healthy { background: rgba(34, 197, 94, 0.2); color: var(--success); }

    .health-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .health-dot.critical { background: var(--danger); animation: pulse 2s infinite; }
    .health-dot.warning { background: var(--warning); }
    .health-dot.healthy { background: var(--success); }

    .health-name { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
    .health-schedule { font-size: 12px; color: var(--text-secondary); }

    .learning-track {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .track-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .track-title { font-size: 16px; font-weight: 600; }
    .track-progress { font-size: 13px; color: var(--text-secondary); }

    .progress-bar {
      height: 8px;
      background: var(--bg-secondary);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #8b5cf6);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .topic-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .topic-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      padding: 8px;
      border-radius: 6px;
      background: var(--bg-secondary);
    }

    .topic-item.done { color: var(--success); }
    .topic-item.current { color: var(--accent); font-weight: 500; }
    .topic-item.pending { color: var(--text-secondary); }

    .topic-check { width: 18px; text-align: center; }

    .user-btn .avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    @media (max-width: 900px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }
    
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--text-primary), var(--text-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .add-task-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .add-task-form {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .task-input {
      flex: 1;
      min-width: 200px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 14px;
      color: var(--text-primary);
      font-size: 14px;
      outline: none;
    }

    .task-input:focus { border-color: var(--accent); }

    .task-select {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 14px;
      color: var(--text-primary);
      font-size: 14px;
      outline: none;
      min-width: 100px;
    }

    .add-btn {
      background: linear-gradient(135deg, var(--accent), #8b5cf6);
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .add-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px var(--accent-glow);
    }

    .add-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .kanban-board {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    @media (max-width: 1200px) {
      .kanban-board { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 600px) {
      .kanban-board { grid-template-columns: 1fr; }
    }

    .kanban-column {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      min-height: 300px;
    }

    .kanban-column.todo { border-top: 3px solid #3b82f6; }
    .kanban-column.inprogress { border-top: 3px solid #f59e0b; }
    .kanban-column.review { border-top: 3px solid #8b5cf6; }
    .kanban-column.done { border-top: 3px solid #22c55e; }

    .kanban-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }

    .kanban-title {
      font-size: 13px;
      font-weight: 600;
    }

    .kanban-count {
      background: var(--bg-secondary);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      color: var(--text-secondary);
    }

    .kanban-tasks {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .kanban-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      cursor: grab;
      transition: all 0.2s ease;
      user-select: none;
    }

    .kanban-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    .kanban-card.dragging {
      opacity: 0.5;
      cursor: grabbing;
      transform: rotate(2deg);
    }

    .kanban-column.drag-over {
      background: rgba(99, 102, 241, 0.1);
      border-color: var(--accent);
    }

    .kanban-column {
      transition: background 0.2s ease;
    }

    .kanban-card-title {
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 6px;
      line-height: 1.4;
    }

    .kanban-card-meta {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .kanban-tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
    }

    .kanban-tag.priority-p0 { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .kanban-tag.priority-p1 { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    .kanban-tag.priority-p2 { background: rgba(99, 102, 241, 0.2); color: #6366f1; }
    .kanban-tag.due-soon { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

    .assignee-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
    }

    .assignee-badge.david { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
    .assignee-badge.alice { background: rgba(168, 85, 247, 0.2); color: #a855f7; }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 30px 20px;
      color: var(--text-secondary);
      font-size: 12px;
    }

    .message {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      animation: slideUp 0.3s ease;
      z-index: 100;
    }

    .message.success { background: var(--success); color: white; }
    .message.error { background: var(--danger); color: white; }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="bg-gradient"></div>
  
  <div class="container">
    <header>
      <div class="brand">
        <div class="brand-icon">‚óÜ</div>
        <div class="brand-text">
          <h1>Task Command Center</h1>
          <p>David Kim ‚Äî CEO</p>
          <div class="sync-status">
            <span class="sync-dot" id="sync-dot"></span>
            <span id="sync-text">Loading...</span>
          </div>
        </div>
      </div>
    </header>

    <div class="user-toggle">
      <button class="user-btn david active" id="btn-david" onclick="setUser('David')">
        <span class="avatar">DK</span>
        David (CEO)
      </button>
      <button class="user-btn alice" id="btn-alice" onclick="setUser('Alice')">
        <span class="avatar">AL</span>
        Alice (Chief of Staff)
      </button>
    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchTab('tasks')">üìã Tasks</button>
      <button class="nav-tab" onclick="switchTab('health')">üè• System Health</button>
      <button class="nav-tab" onclick="switchTab('learning')">üìö Learning</button>
    </div>

    <!-- TASKS TAB -->
    <div id="tab-tasks" class="tab-content active">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="stat-total">-</div>
        <div class="stat-label">Total Tasks</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-todo">-</div>
        <div class="stat-label">To Do</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-inprogress">-</div>
        <div class="stat-label">In Progress</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-done">-</div>
        <div class="stat-label">Done</div>
      </div>
    </div>

    <div class="add-task-section">
      <div class="add-task-form">
        <input type="text" class="task-input" id="task-name" placeholder="Add a new task...">
        <select class="task-select" id="task-priority">
          <option value="P0">P0</option>
          <option value="P1" selected>P1</option>
          <option value="P2">P2</option>
        </select>
        <select class="task-select" id="task-assignee">
          <option value="David">David</option>
          <option value="Alice">Alice</option>
        </select>
        <input type="date" class="task-select" id="task-due">
        <button class="add-btn" id="add-btn" onclick="addTask()">Add Task</button>
      </div>
    </div>

    <div class="kanban-board" id="kanban-board">
      <div class="kanban-column todo">
        <div class="kanban-header">
          <span class="kanban-title">To Do</span>
          <span class="kanban-count" id="count-todo">0</span>
        </div>
        <div class="kanban-tasks" id="kanban-todo">
          <div class="loading"><div class="spinner"></div>Loading...</div>
        </div>
      </div>

      <div class="kanban-column inprogress">
        <div class="kanban-header">
          <span class="kanban-title">In Progress</span>
          <span class="kanban-count" id="count-inprogress">0</span>
        </div>
        <div class="kanban-tasks" id="kanban-inprogress">
          <div class="loading"><div class="spinner"></div>Loading...</div>
        </div>
      </div>

      <div class="kanban-column review">
        <div class="kanban-header">
          <span class="kanban-title">Review</span>
          <span class="kanban-count" id="count-review">0</span>
        </div>
        <div class="kanban-tasks" id="kanban-review">
          <div class="loading"><div class="spinner"></div>Loading...</div>
        </div>
      </div>

      <div class="kanban-column done">
        <div class="kanban-header">
          <span class="kanban-title">Done</span>
          <span class="kanban-count" id="count-done">0</span>
        </div>
        <div class="kanban-tasks" id="kanban-done">
          <div class="loading"><div class="spinner"></div>Loading...</div>
        </div>
      </div>
    </div>
  </div>
  </div>
  <!-- END TASKS TAB -->

  <!-- HEALTH TAB -->
  <div id="tab-health" class="tab-content">
    <div class="health-grid">
      <div class="health-card healthy">
        <div class="health-status healthy"><span class="health-dot healthy"></span>HEALTHY</div>
        <div class="health-name">Morning Brief</div>
        <div class="health-schedule">Daily at 08:00 KST</div>
      </div>
      <div class="health-card healthy">
        <div class="health-status healthy"><span class="health-dot healthy"></span>HEALTHY</div>
        <div class="health-name">Heartbeat (09:00)</div>
        <div class="health-schedule">Daily at 09:00 KST</div>
      </div>
      <div class="health-card healthy">
        <div class="health-status healthy"><span class="health-dot healthy"></span>HEALTHY</div>
        <div class="health-name">Heartbeat (15:00)</div>
        <div class="health-schedule">Daily at 15:00 KST</div>
      </div>
      <div class="health-card healthy">
        <div class="health-status healthy"><span class="health-dot healthy"></span>HEALTHY</div>
        <div class="health-name">Heartbeat (21:00)</div>
        <div class="health-schedule">Daily at 21:00 KST</div>
      </div>
      <div class="health-card warning">
        <div class="health-status warning"><span class="health-dot warning"></span>WARNING</div>
        <div class="health-name">Nightly Build</div>
        <div class="health-schedule">Daily at 01:00 KST</div>
      </div>
      <div class="health-card healthy">
        <div class="health-status healthy"><span class="health-dot healthy"></span>HEALTHY</div>
        <div class="health-name">Health Check</div>
        <div class="health-schedule">Multiple times daily</div>
      </div>
    </div>
    <div class="learning-track">
      <div class="track-header">
        <div class="track-title">Recent System Events</div>
      </div>
      <div class="topic-list">
        <div class="topic-item done"><span class="topic-check">‚úì</span> 09:00 Heartbeat ‚Äî Completed successfully</div>
        <div class="topic-item done"><span class="topic-check">‚úì</span> Morning Brief ‚Äî Delivered at 08:00 KST</div>
        <div class="topic-item current"><span class="topic-check">‚ü≥</span> Nightly Build ‚Äî Deploy pending (token issue)</div>
      </div>
    </div>
  </div>
  <!-- END HEALTH TAB -->

  <!-- LEARNING TAB -->
  <div id="tab-learning" class="tab-content">
    <div class="learning-track">
      <div class="track-header">
        <div class="track-title">üêç Python (CS50P)</div>
        <div class="track-progress">Week 4 of 9</div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" style="width: 44%"></div>
      </div>
      <div class="topic-list">
        <div class="topic-item done"><span class="topic-check">‚úì</span> Week 0: Functions</div>
        <div class="topic-item done"><span class="topic-check">‚úì</span> Week 1: Conditionals</div>
        <div class="topic-item done"><span class="topic-check">‚úì</span> Week 2: Loops</div>
        <div class="topic-item done"><span class="topic-check">‚úì</span> Week 3: Exceptions</div>
        <div class="topic-item current"><span class="topic-check">‚Üí</span> Week 4: Libraries (current)</div>
        <div class="topic-item pending"><span class="topic-check">‚óã</span> Week 5: Unit Tests</div>
        <div class="topic-item pending"><span class="topic-check">‚óã</span> Week 6: File I/O</div>
        <div class="topic-item pending"><span class="topic-check">‚óã</span> Week 7: Regex</div>
        <div class="topic-item pending"><span class="topic-check">‚óã</span> Week 8: OOP</div>
        <div class="topic-item pending"><span class="topic-check">‚óã</span> Week 9: Et Cetera</div>
      </div>
    </div>

    <div class="learning-track">
      <div class="track-header">
        <div class="track-title">üìê Math for AI/ML</div>
        <div class="track-progress">Module 2 of 4</div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" style="width: 50%"></div>
      </div>
      <div class="topic-list">
        <div class="topic-item done"><span class="topic-check">‚úì</span> Linear Algebra: Vectors</div>
        <div class="topic-item done"><span class="topic-check">‚úì</span> Linear Algebra: Matrices</div>
        <div class="topic-item done"><span class="topic-check">‚úì</span> Linear Algebra: Dot Product</div>
        <div class="topic-item done"><span class="topic-check">‚úì</span> Calculus: Derivatives</div>
        <div class="topic-item done"><span class="topic-check">‚úì</span> Calculus: Chain Rule</div>
        <div class="topic-item done"><span class="topic-check">‚úì</span> Calculus: Gradient Descent</div>
        <div class="topic-item current"><span class="topic-check">‚Üí</span> Probability: Distributions (current)</div>
        <div class="topic-item pending"><span class="topic-check">‚óã</span> Probability: Bayes Theorem</div>
        <div class="topic-item pending"><span class="topic-check">‚óã</span> Optimization: SGD</div>
        <div class="topic-item pending"><span class="topic-check">‚óã</span> Optimization: Regularization</div>
      </div>
    </div>
  </div>
  <!-- END LEARNING TAB -->

  <script>
    const PROXY_URL = 'https://notion-proxy.rla-alstn.workers.dev';
    let currentUser = 'David';
    let allTasks = [];
    
    document.getElementById('task-assignee').value = currentUser;
    fetchTasks();
    setInterval(fetchTasks, 60000);
    
    function setUser(user) {
      currentUser = user;
      document.getElementById('btn-david').className = user === 'David' ? 'user-btn david active' : 'user-btn david';
      document.getElementById('btn-alice').className = user === 'Alice' ? 'user-btn alice active' : 'user-btn alice';
      document.getElementById('task-assignee').value = user;
      renderKanban();
      updateStats();
    }

    function switchTab(tabName) {
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById('tab-' + tabName).classList.add('active');
    }

    async function fetchTasks() {
      const dot = document.getElementById('sync-dot');
      const text = document.getElementById('sync-text');
      dot.className = 'sync-dot syncing';
      text.textContent = 'Syncing...';
      
      try {
        const response = await fetch(PROXY_URL + '/tasks');
        const data = await response.json();
        
        if (data.success) {
          allTasks = data.tasks;
          renderKanban();
          updateStats();
          dot.className = 'sync-dot';
          text.textContent = 'Synced: ' + new Date().toLocaleTimeString();
        }
      } catch (error) {
        console.error('Fetch error:', error);
        dot.className = 'sync-dot error';
        text.textContent = 'Sync failed';
        document.getElementById('kanban-todo').innerHTML = '<div class="empty-state">Error loading tasks. Check console.</div>';
      }
    }
    
    async function addTask() {
      const name = document.getElementById('task-name').value.trim();
      const priority = document.getElementById('task-priority').value;
      const assignee = document.getElementById('task-assignee').value;
      const due = document.getElementById('task-due').value;
      
      if (!name) {
        showMessage('Please enter a task name', 'error');
        return;
      }
      
      const btn = document.getElementById('add-btn');
      btn.disabled = true;
      btn.textContent = 'Adding...';
      
      try {
        const response = await fetch(PROXY_URL + '/tasks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, priority, assignee, due, status: 'Todo' })
        });
        
        const data = await response.json();
        
        if (data.success) {
          document.getElementById('task-name').value = '';
          document.getElementById('task-due').value = '';
          showMessage('Task added!', 'success');
          await fetchTasks();
        } else {
          showMessage('Failed: ' + (data.error || 'Unknown'), 'error');
        }
      } catch (error) {
        showMessage('Error: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Add Task';
      }
    }
    
    function updateStats() {
      const userTasks = allTasks.filter(t => t.assignee === currentUser);
      const total = userTasks.length;
      const todo = userTasks.filter(t => !t.status || t.status === 'Todo').length;
      const inprogress = userTasks.filter(t => t.status === 'In Progress').length;
      const done = userTasks.filter(t => t.status === 'Done').length;
      
      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-todo').textContent = todo;
      document.getElementById('stat-inprogress').textContent = inprogress;
      document.getElementById('stat-done').textContent = done;
      
      document.getElementById('count-todo').textContent = todo;
      document.getElementById('count-inprogress').textContent = inprogress;
      document.getElementById('count-review').textContent = userTasks.filter(t => t.status === 'Review').length;
      document.getElementById('count-done').textContent = done;
    }
    
    let draggedTaskId = null;

    function renderKanban() {
      const userTasks = allTasks.filter(t => t.assignee === currentUser);
      
      const columns = {
        'Todo': document.getElementById('kanban-todo'),
        'In Progress': document.getElementById('kanban-inprogress'),
        'Review': document.getElementById('kanban-review'),
        'Done': document.getElementById('kanban-done')
      };
      
      Object.values(columns).forEach(col => {
        col.innerHTML = '';
        // Add drag handlers to columns
        col.ondragover = handleDragOver;
        col.ondragleave = handleDragLeave;
        col.ondrop = handleDrop;
      });
      
      const sortedTasks = [...userTasks].sort((a, b) => {
        const order = { 'P0': 0, 'P1': 1, 'P2': 2, 'P3': 3, null: 4 };
        return (order[a.priority] || 4) - (order[b.priority] || 4);
      });
      
      sortedTasks.forEach(task => {
        const status = task.status || 'Todo';
        const col = columns[status] || columns['Todo'];
        
        const card = document.createElement('div');
        card.className = 'kanban-card';
        card.draggable = true;
        card.dataset.taskId = task.id;
        card.dataset.status = status;
        
        // Drag handlers
        card.ondragstart = handleDragStart;
        card.ondragend = handleDragEnd;
        
        let metaHtml = '';
        if (task.priority) {
          metaHtml += '<span class="kanban-tag priority-' + task.priority.toLowerCase() + '">' + task.priority + '</span>';
        }
        if (task.due) {
          const overdue = new Date(task.due) < new Date();
          metaHtml += '<span class="kanban-tag ' + (overdue ? 'due-soon' : '') + '">' + formatDate(task.due) + '</span>';
        }
        metaHtml += '<span class="assignee-badge ' + (task.assignee || 'david').toLowerCase() + '">' + (task.assignee || 'David') + '</span>';
        
        card.innerHTML = '<div class="kanban-card-title">' + escapeHtml(task.name) + '</div><div class="kanban-card-meta">' + metaHtml + '</div>';
        
        card.onclick = function(e) {
          if (!draggedTaskId) {
            window.open('https://www.notion.so/s7yle/' + task.id.replace(/-/g, ''), '_blank');
          }
        };
        col.appendChild(card);
      });
      
      Object.entries(columns).forEach(([status, col]) => {
        if (col.children.length === 0) {
          col.innerHTML = '<div class="empty-state">No tasks</div>';
        }
      });
    }

    function handleDragStart(e) {
      draggedTaskId = this.dataset.taskId;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', draggedTaskId);
    }

    function handleDragEnd(e) {
      this.classList.remove('dragging');
      draggedTaskId = null;
      // Remove drag-over from all columns
      document.querySelectorAll('.kanban-column').forEach(col => {
        col.classList.remove('drag-over');
      });
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      this.closest('.kanban-column').classList.add('drag-over');
    }

    function handleDragLeave(e) {
      this.closest('.kanban-column').classList.remove('drag-over');
    }

    function handleDrop(e) {
      e.preventDefault();
      const column = this.closest('.kanban-column');
      column.classList.remove('drag-over');
      
      const taskId = e.dataTransfer.getData('text/plain');
      const newStatus = getStatusFromColumn(column);
      
      if (taskId && newStatus) {
        updateTaskStatus(taskId, newStatus);
      }
    }

    function getStatusFromColumn(column) {
      if (column.classList.contains('todo')) return 'Todo';
      if (column.classList.contains('inprogress')) return 'In Progress';
      if (column.classList.contains('review')) return 'Review';
      if (column.classList.contains('done')) return 'Done';
      return null;
    }

    async function updateTaskStatus(taskId, newStatus) {
      showMessage('Updating...', 'success');
      
      try {
        const response = await fetch(PROXY_URL + '/tasks/' + taskId, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: newStatus })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Update local task and re-render
          const task = allTasks.find(t => t.id === taskId);
          if (task) {
            task.status = newStatus;
            renderKanban();
            updateStats();
            showMessage('Status updated!', 'success');
          }
        } else {
          showMessage('Failed: ' + (data.error || 'Unknown'), 'error');
          await fetchTasks(); // Refresh to get correct state
        }
      } catch (error) {
        showMessage('Error: ' + error.message, 'error');
        await fetchTasks();
      }
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const today = new Date();
      const diff = Math.floor((date - today) / (1000 * 60 * 60 * 24));
      if (diff < 0) return 'Overdue';
      if (diff === 0) return 'Today';
      if (diff === 1) return 'Tomorrow';
      return (date.getMonth() + 1) + '/' + date.getDate();
    }
    
    function showMessage(text, type) {
      const msg = document.createElement('div');
      msg.className = 'message ' + type;
      msg.textContent = text;
      document.body.appendChild(msg);
      setTimeout(function() { msg.remove(); }, 3000);
    }
    
    document.getElementById('task-name').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') addTask();
    });
  </script>
</body>
</html>
